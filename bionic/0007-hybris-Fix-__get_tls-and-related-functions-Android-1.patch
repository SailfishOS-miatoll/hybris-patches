From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Franz-Josef Haider <franz.haider@jolla.com>
Date: Thu, 8 Oct 2020 14:43:42 +0000
Subject: [PATCH] (hybris) Fix __get_tls and related functions (>=Android 11)

Signed-off-by: Simonas Leleiva <simonas.leleiva@jolla.com>
Signed-off-by: Franz-Josef Haider <frajo.haider@jolla.com>
Change-Id: I24486873be638a1a8cd123705ba2e51ec7414b94
---
 libc/Android.bp       | 1 +
 libc/hybris_support.c | 5 +++++
 libc/libc.map.txt     | 1 +
 3 files changed, 7 insertions(+)
 create mode 100644 libc/hybris_support.c

diff --git a/libc/Android.bp b/libc/Android.bp
index 544a1e0b46f58392855c18ca3d349f8041ac3008..df7023867502d6952021d6f54e405106d5b9443d 100644
--- a/libc/Android.bp
+++ b/libc/Android.bp
@@ -24,6 +24,7 @@ libc_common_src_files = [
     "bionic/ether_aton.c",
     "bionic/ether_ntoa.c",
     "bionic/exit.cpp",
+    "hybris_support.c",
     "bionic/initgroups.c",
     "bionic/isatty.c",
     "bionic/sched_cpualloc.c",
diff --git a/libc/hybris_support.c b/libc/hybris_support.c
new file mode 100644
index 0000000000000000000000000000000000000000..2188f40005a837d36d7d7d3a97988436f64c2593
--- /dev/null
+++ b/libc/hybris_support.c
@@ -0,0 +1,5 @@
+
+void** __get_tls_hooks(void) {
+#include "platform/bionic/tls.h"
+  return __get_tls();
+}
diff --git a/libc/libc.map.txt b/libc/libc.map.txt
index 7397b687cf2c2aafa11476292c40324e9b3fbda5..9f803516893d9386fbb75c152690b85438389d05 100644
--- a/libc/libc.map.txt
+++ b/libc/libc.map.txt
@@ -41,6 +41,7 @@ LIBC {
     __fstatfs64; # arm x86
     __fwritable; # introduced=23
     __get_h_errno;
+    __get_tls_hooks; # arm arm64 x86 introduced=21
     __getcpu; # arm x86 introduced-arm=12 introduced-x86=12
     __getcwd; # arm x86
     __getpid; # arm x86 introduced=21
