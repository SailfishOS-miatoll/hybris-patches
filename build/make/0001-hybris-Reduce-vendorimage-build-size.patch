From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Matti=20Lehtim=C3=A4ki?= <matti.lehtimaki@gmail.com>
Date: Fri, 22 Mar 2019 18:36:56 +0200
Subject: [PATCH] (hybris) Reduce vendorimage build size.

Change-Id: Id025a7d7c81cb19c2881ff6619084b638ce983fb
---
 core/Makefile | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/core/Makefile b/core/Makefile
index c19b0754af5b9ec33e81286de177e4a0f09614ec..ab4b9e0b883d3be1837a2ce1bf6dca3dff19b1f5 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -63,6 +63,7 @@ check_elf_prebuilt_product_copy_files_hint := \
     found ELF prebuilt in PRODUCT_COPY_FILES, use cc_prebuilt_binary / cc_prebuilt_library_shared instead.
 
 # filter out the duplicate <source file>:<dest file> pairs.
+ALL_PRODUCT_COPY_FILES :=
 unique_product_copy_files_pairs :=
 $(foreach cf,$(PRODUCT_COPY_FILES), \
     $(if $(filter $(unique_product_copy_files_pairs),$(cf)),,\
@@ -86,6 +87,7 @@ $(foreach cf,$(unique_product_copy_files_pairs), \
                                $(filter bin lib lib64,$(subst /,$(space),$(_dest)))), \
                         $(eval $(call copy-non-elf-file-checked,$(_src),$(_fulldest),$(check_elf_prebuilt_product_copy_files_hint))), \
                         $(eval $(call copy-one-file,$(_src),$(_fulldest))))))) \
+        $(eval ALL_PRODUCT_COPY_FILES += $(_fulldest)) \
         $(eval unique_product_copy_files_destinations += $(_dest))))
 
 # Dump a list of overriden (and ignored PRODUCT_COPY_FILES entries)
@@ -3578,14 +3580,18 @@ define build-vendorimage-target
   $(call assert-max-image-size,$(INSTALLED_VENDORIMAGE_TARGET) $(RECOVERY_FROM_BOOT_PATCH),$(BOARD_VENDORIMAGE_PARTITION_SIZE))
 endef
 
+INTERNAL_VENDORIMAGE_KERNEL_MODULES := \
+    $(filter $(TARGET_OUT_VENDOR)/lib/modules/%,\
+      $(ALL_DEFAULT_INSTALLED_MODULES)\
+      $(ALL_PDK_FUSION_FILES))
+
 # We just build this directly to the install location.
 INSTALLED_VENDORIMAGE_TARGET := $(BUILT_VENDORIMAGE_TARGET)
 $(INSTALLED_VENDORIMAGE_TARGET): \
     $(INTERNAL_USERIMAGES_DEPS) \
-    $(INTERNAL_VENDORIMAGE_FILES) \
-    $(INSTALLED_FILES_FILE_VENDOR) \
+    $(ALL_PRODUCT_COPY_FILES) \
+    $(INTERNAL_VENDORIMAGE_KERNEL_MODULES) \
     $(RECOVERY_FROM_BOOT_PATCH)
-	$(build-vendorimage-target)
 
 VENDOR_NOTICE_DEPS += $(INSTALLED_VENDORIMAGE_TARGET)
 
